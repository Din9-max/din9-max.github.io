<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AR Santa Hat</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: black;
        }
        #webcam {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #output {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
        }
        button {
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            font-size: 16px;
        }
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            z-index: 100;
        }
        .start-screen h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        .start-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 80%;
        }
        #startMain {
            background: #ff0000;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="start-screen" id="startScreen">
        <h1>üéÖ AR –®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã</h1>
        <p>–ù–∞–¥–µ–Ω—å—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —à–∞–ø–∫—É –°–∞–Ω—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!</p>
        <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.</p>
        <button id="startMain">–ù–ê–ß–ê–¢–¨</button>
    </div>
    
    <video id="webcam" autoplay playsinline></video>
    <canvas id="output" width="1280" height="720"></canvas>
    
    <div class="controls" style="display: none;" id="controlsDiv">
        <button id="start">–°–¢–ê–†–¢</button>
        <button id="stop">–°–¢–û–ü</button>
        <button id="switch">–ü–ï–†–ï–ö–õ–Æ–ß–ò–¢–¨ –ö–ê–ú–ï–†–£</button>
        <div>AR –®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã - –†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ!</div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('start');
        const stopButton = document.getElementById('stop');
        const switchButton = document.getElementById('switch');
        const startScreen = document.getElementById('startScreen');
        const controlsDiv = document.getElementById('controlsDiv');
        const startMainButton = document.getElementById('startMain');
        
        let currentStream;
        let isRunning = false;
        let cameraInstance = null;
        
        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–ø–∫–∏
        let hatImage = new Image();
        hatImage.src = 'my_hat.png';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å Face Mesh
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π
        async function startCamera(facingMode = 'user') {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
                return Promise.reject(err);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function onResults(results) {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –≤–∏–¥–µ–æ
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                for (const landmarks of results.multiFaceLandmarks) {
                    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏ –ª–∏—Ü–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–ø–∫–∏
                    const forehead = landmarks[10];  // —Ç–æ—á–∫–∞ –Ω–∞ –ª–±—É
                    const leftTemple = landmarks[234];
                    const rightTemple = landmarks[454];
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã canvas
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    const foreheadX = forehead.x * canvasWidth;
                    const foreheadY = forehead.y * canvasHeight;
                    
                    const leftX = leftTemple.x * canvasWidth;
                    const rightX = rightTemple.x * canvasWidth;
                    
                    const faceWidth = rightX - leftX;
                    
                    // –†–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è —à–∞–ø–∫–∏
                    const hatWidth = faceWidth * 1.8;
                    const hatHeight = hatWidth * 0.67;
                    
                    const hatX = foreheadX - hatWidth / 2;
                    const hatY = foreheadY - hatHeight * 0.7;
                    
                    // –†–∏—Å—É–µ–º —à–∞–ø–∫—É
                    if (hatImage.complete) {
                        ctx.drawImage(hatImage, hatX, hatY, hatWidth, hatHeight);
                    }
                }
            }
            
            ctx.restore();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        async function startProcessing() {
            if (!isRunning) {
                isRunning = true;
                startButton.textContent = "–ü–ê–£–ó–ê";
                
                if (!cameraInstance) {
                    cameraInstance = new Camera(video, {
                        onFrame: async () => {
                            await faceMesh.send({image: video});
                        },
                        width: canvas.width,
                        height: canvas.height
                    });
                    await cameraInstance.start();
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        function stopProcessing() {
            if (isRunning) {
                isRunning = false;
                startButton.textContent = "–°–¢–ê–†–¢";
                if (cameraInstance) {
                    cameraInstance.stop();
                    cameraInstance = null;
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        startMainButton.onclick = async () => {
            try {
                // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
                startScreen.style.display = 'none';
                controlsDiv.style.display = 'block';
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
                await startCamera();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
                await startProcessing();
            } catch (err) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω —Å–Ω–æ–≤–∞
                startScreen.style.display = 'flex';
                controlsDiv.style.display = 'none';
            }
        };
        
        startButton.onclick = async () => {
            if (isRunning) {
                stopProcessing();
            } else {
                await startProcessing();
            }
        };
        
        stopButton.onclick = () => {
            stopProcessing();
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
            startScreen.style.display = 'flex';
            controlsDiv.style.display = 'none';
            isRunning = false;
        };
        
        switchButton.onclick = async () => {
            try {
                const facingMode = currentStream ?
                    (currentStream.getVideoTracks()[0].getSettings().facingMode === 'user' ?
                        'environment' : 'user') : 'user';
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                stopProcessing();
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                await startCamera(facingMode);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–Ω–æ–≤–∞
                await startProcessing();
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É");
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à–∞–ø–∫–∏
        hatImage.onerror = () => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à–∞–ø–∫–∏");
        };
        
        // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        // –¢–µ–ø–µ—Ä—å –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏
    </script>
</body>
</html>

