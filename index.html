<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AR Santa Hat</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: black;
        }
        #webcam {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #output {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
        }
        button {
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="output" width="1280" height="720"></canvas>
    
    <div class="controls">
        <button id="start">СТАРТ</button>
        <button id="stop">СТОП</button>
        <button id="switch">ПЕРЕКЛЮЧИТЬ КАМЕРУ</button>
        <div>AR Шапка Санты - Работает в браузере!</div>
    </div>

    <script>
        // Элементы
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('start');
        const stopButton = document.getElementById('stop');
        const switchButton = document.getElementById('switch');
        
        let currentStream;
        let hatImage = new Image();
        hatImage.src = 'data:image/svg+xml;base64,' + btoa(`
            <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="150" cy="50" rx="120" ry="50" fill="red"/>
                <rect x="30" y="50" width="240" height="100" fill="darkred"/>
                <rect x="30" y="130" width="240" height="20" fill="white"/>
                <circle cx="150" cy="30" r="20" fill="white"/>
            </svg>
        `);
        
        // Загружаем модель Face Mesh
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
        
        // Функция для начала работы с камерой
        async function startCamera(facingMode = 'user') {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (err) {
                console.error("Ошибка камеры:", err);
                alert("Не удалось получить доступ к камере");
            }
        }
        
        // Обработка результатов
        function onResults(results) {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем видео
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            if (results.multiFaceLandmarks) {
                for (const landmarks of results.multiFaceLandmarks) {
                    // Находим точки лица для позиционирования шапки
                    const forehead = landmarks[10];  // точка на лбу
                    const leftTemple = landmarks[234];
                    const rightTemple = landmarks[454];
                    
                    // Преобразуем в координаты canvas
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    const foreheadX = forehead.x * canvasWidth;
                    const foreheadY = forehead.y * canvasHeight;
                    
                    const leftX = leftTemple.x * canvasWidth;
                    const rightX = rightTemple.x * canvasWidth;
                    
                    const faceWidth = rightX - leftX;
                    
                    // Размер и позиция шапки
                    const hatWidth = faceWidth * 1.8;
                    const hatHeight = hatWidth * 0.67;
                    
                    const hatX = foreheadX - hatWidth / 2;
                    const hatY = foreheadY - hatHeight;
                    
                    // Рисуем шапку
                    if (hatImage.complete) {
                        ctx.drawImage(hatImage, hatX, hatY, hatWidth, hatHeight);
                    }
                }
            }
            
            ctx.restore();
        }
        
        // Обработчики кнопок
        startButton.onclick = async () => {
            await startCamera();
            await faceMesh.send({image: video});
        };
        
        stopButton.onclick = () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };
        
        switchButton.onclick = async () => {
            const facingMode = video.srcObject ?
                (video.srcObject.getVideoTracks()[0].getSettings().facingMode === 'user' ?
                    'environment' : 'user') : 'user';
            await startCamera(facingMode);
        };
        
        // Запускаем обработку кадров
        const camera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({image: video});
            },
            width: 1280,
            height: 720
        });
        
        // Автозапуск при загрузке
        window.onload = async () => {
            await startCamera();
            camera.start();
        };
    </script>
</body>
</html>